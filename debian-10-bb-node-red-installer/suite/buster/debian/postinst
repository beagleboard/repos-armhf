#!/bin/sh
#
# see: dh_installdeb(1)

set -e

package="bb-node-red-installer"
service="nodered"

npm_pkg_install () {
	echo "${package}:installing:[${npm_file}]"
	if [ ! -d /usr/local/lib/node_modules/ ] ; then
		mkdir -p /usr/local/lib/node_modules/ || true
	fi
	if [ -d /usr/local/lib/node_modules/${npm_project}/ ] ; then
		rm -rf /usr/local/lib/node_modules/${npm_project}/ || true
	fi

	echo "${package}:updating:[/usr/local/lib/node_modules/${npm_project}/]"
	tar xf /var/cache/${package}/${npm_file} -C /usr/local/lib/node_modules/
}

npm_install () {
	node_bin="/usr/bin/nodejs"

	unset node_version
	node_version=$(/usr/bin/nodejs --version || true)
	echo "${package}:nodejs:[${node_version}]"

v10="v10.15.2"

           node_red="node-red-1.0.2"
      node_red_gpio="node-red-contrib-gpio-0.14.0"
node_red_mjpgcamera="node-red-contrib-mjpgcamera-1.0.4"
  node_red_particle="node-red-contrib-particle-1.1.0"
 node_red_dashboard="node-red-dashboard-2.17.1"
    node_red_serial="node-red-node-serialport-0.8.8"
   node_red_blockly="node-red-contrib-blockly-1.1.0"

	npm_project="node-red"
	case "${node_version}" in
	v10.*)
		npm_file="${node_red}-${v10}.tar.xz"
		npm_pkg_install
		;;
	esac

	ln -sf /usr/local/lib/node_modules/node-red/red.js /usr/local/bin/node-red
	ln -sf /usr/local/lib/node_modules/node-red/bin/node-red-pi /usr/local/bin/node-red-pi

	case "${node_version}" in
	v10.*)
		npm_project="node-red-contrib-gpio"
		npm_file="${node_red_gpio}-${v10}.tar.xz"
		npm_pkg_install

		npm_project="node-red-contrib-mjpgcamera"
		npm_file="${node_red_mjpgcamera}-${v10}.tar.xz"
		npm_pkg_install

		npm_project="node-red-contrib-particle"
		npm_file="${node_red_particle}-${v10}.tar.xz"
		npm_pkg_install

		npm_project="node-red-dashboard"
		npm_file="${node_red_dashboard}-${v10}.tar.xz"
		npm_pkg_install

		npm_project="node-red-node-serialport"
		npm_file="${node_red_serial}-${v10}.tar.xz"
		npm_pkg_install

		npm_project="node-red-contrib-blockly"
		npm_file="${node_red_blockly}-${v10}.tar.xz"
		npm_pkg_install

		;;
	esac

	if [ -d /usr/lib/node_modules/mraa ] ; then
		ln -sf /usr/lib/node_modules/mraa /usr/local/lib/node_modules || true
		ln -sf /usr/lib/node_modules/jsupm* /usr/local/lib/node_modules || true
	fi

	if [ -d /usr/local/lib/node_modules/node-red-node-beaglebone/ ] ; then
		rm -rf /usr/local/lib/node_modules/node-red-node-beaglebone/ || true
	fi

	if [ -d /usr/local/lib/node_modules/node-red-node-mongodb/ ] ; then
		rm -rf /usr/local/lib/node_modules/node-red-node-mongodb/ || true
	fi

	if [ -d /usr/local/lib/node_modules/node-red-contrib-can/ ] ; then
		rm -rf /usr/local/lib/node_modules/node-red-contrib-can/ || true
	fi

	if [ -d /etc/avahi/services/ ] ; then
		#Annouce http server via DNS Sevice Discovery
		wfile="/etc/avahi/services/nodered.service"
		echo "<?xml version=\"1.0\" standalone='no'?><!--*-nxml-*-->" > ${wfile}
		echo "<!DOCTYPE service-group SYSTEM \"avahi-service.dtd\">" >> ${wfile}
		echo "" >> ${wfile}
		echo "<!-- See avahi.service(5) for more information about this configuration file -->" >> ${wfile}
		echo "" >> ${wfile}
		echo "<service-group>" >> ${wfile}
		echo "" >> ${wfile}
		echo "  <name replace-wildcards=\"yes\">Node-RED for %h</name>" >> ${wfile}
		echo "  <service>" >> ${wfile}
		echo "" >> ${wfile}
		echo "    <type>_http._tcp</type>" >> ${wfile}
		echo "    <port>1880</port>" >> ${wfile}
		echo "  </service>" >> ${wfile}
		echo "" >> ${wfile}
		echo "</service-group>" >> ${wfile}
		chown -R root:root ${wfile}
	fi

	systemctl enable ${service}.socket || true
	systemctl enable ${service} || true
	#systemctl start ${service} || true
	echo "${package}:Installed"
}

case "$1" in
    configure)
	npm_install
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

